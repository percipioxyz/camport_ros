<!-- Entry point for using Percipio devices -->
<launch>

  <!-- "camera" should uniquely identify the device. All topics are pushed down
       into the "camera" namespace, and it is prepended to tf frame ids. -->
  <arg name="camera" default="camera" />
  <arg name="rgb_frame_id"   default="$(arg camera)_rgb_optical_frame" />
  <arg name="depth_frame_id" default="$(arg camera)_depth_optical_frame" />
  <arg name="ir_frame_id" default="$(arg camera)_ir_optical_frame" />

  <arg name="use_ros_nodelet" default="true" />

  <!-- device_id can have the following formats:
         "#1"           : the first device found
         "serial number : select the camera with a specified serial number" 
         "IP            : select the net camera with a specified IP"   -->
  <arg name="device_id" default="#1" />

  <!-- percipio camera initialization configuration parameter file -->
  <param name="percipio_camera_parameter" textfile="$(find percipio_launch)/parameters.xml" />
  
  <!--If the device is offline or disconnected, the driver will attempt to reconnect -->
  <arg name="device_reconnection" default="true" />

  <!-- Device log configuration -->
  <arg name="device_log_enable" default="false" />
  <!-- VERBOSE / DEBUG / INFO / WARNING / ERROR / NEVER -->
  <arg name="device_log_level" default="ERROR" /> 
  <arg name="device_log_server_port" default="9001" />

  <!-- Whether to enable frame rate control for device output images -->
  <arg name="frame_rate_control" default="false" /> 
  <!-- Frame rate parameter for device output images (floating point number) --> 
  <arg name="frame_rate" default="5.0" /> 
  
  <!-- Whether to set the device operation mode to trigger mode --> 
  <!-- Note that trigger_mode and frame_rate_control are contradictory. 
  If frame_rate_control is enabled, then trigger_mode will be deactivated.-->
  <arg name="trigger_mode" default="false" />
  <!-- Topic path for publishing soft trigger signals to the device --> 
  <arg name="soft_trigger_topic" default="/$(arg camera)/soft_trigger" />

  <!-- Subscription Topic for User Dynamic Configuration Parameters -->
  <arg name="dynamic_configure_topic" default="/$(arg camera)/dynamic_config" />

  <!-- Driver parameters -->
  <arg name="rgb_resolution" default="640x480" />
  <arg name="depth_resolution" default="640x480" />

  <!-- rgb pixel format: mono / bayer / bgr / yuv / jpeg-->
  <arg name="rgb_format" default="" />

  <!-- depth format: depth16 / xyz48 -->
  <arg name="depth_format" default="" />
  
  <!-- Software depth registration -->
  <arg name="depth_registration" default="true" />

  <!-- Software color undistortion -->
  <arg name="color_undistortion" default="true" />

  <!-- IR Image Rectification Switch
        Note: The rectification logic for IR images varies across different camera models:
            1. For binocular stereo 3D cameras, IR image rectification is automatically performed by the camera's internal hardware.
            2. For TOF cameras, IR image rectification requires reading distortion parameters from the camera and performing distortion correction processing on the host computer.
            3. For line-scan 3D cameras, IR image rectification requires reading calibration data from the camera and performing epipolar rectification processing on the host computer.  
  -->
  <arg name="ir_undistortion"  default="true" />

  <!-- Speckle filtering enable/disable switch-->
  <arg name="depth_speckle_filter"              default="false" />
  <!-- Blob size smaller than this will be removed-->
  <arg name="max_speckle_size"                  default="150" />
  <!-- Maximum difference between neighbor disparity pixels.-->
  <arg name="max_speckle_diff"                  default="64" />
  <!-- Maximum Speckle Physical Size to be Filtered-Out, unit is mm^2-->
  <arg name="max_physical_size"                  default="20.0" />
  
  <!-- depth stream time-domain filtering enable/disable switch-->
  <arg name="depth_time_domain_filter"          default="false" />
  <!-- Time-domain filtering frame countï¼š2 - 10 -->
  <arg name="depth_time_domain_num"             default="3" />

  <!-- IR image enhancement method selection. Choose from:-->
  <!--    'off'           - Disable IR image enhancement-->
  <!--    'linear'        - Linear stretch (excludes 10% borders, stretches to full 0-255 range)-->
  <!--    'multi_linear'  - Multiplicative linear stretch (scales by coefficient, different for 8/16-bit)-->
  <!--    'std_linear'    - Standard deviation-based stretch (uses image statistics for dynamic range adjustment)-->
  <!--    'log'           - Logarithmic stretch (enhances low-intensity regions using log2 transformation)-->
  <!--    'hist'          - Histogram equalization (redistributes intensities for maximum contrast)-->
  <!-- Note: Only 'multi_linear', 'std_linear', and 'log' methods use the coefficient parameter.-->
  <!-- Default: 'off' (no enhancement applied)."-->
  <arg name="ir_enhancement" default="off"/>

  <!-- "Coefficient parameter for specific IR enhancement methods. -->
  <!--    This parameter affects three enhancement methods:-->
  <!--      1. 'multi_linear' method:-->
  <!--         - For 8-bit images: pixel_value x coefficient-->
  <!--         - For 16-bit images: pixel_value x (coefficient / 255.0)-->
  <!--         - Recommended range: 1-20 (values > 1 increase brightness)-->
  <!--      2. 'std_linear' method:-->
  <!--         - Normalization factor = (std_dev x coefficient) + 1.0-->
  <!--         - Higher values create more aggressive stretching-->
  <!--         - Recommended range: 3-10-->
  <!--      3. 'log' method:-->
  <!--         - Output = coefficient x log2(pixel_value + 1)-->
  <!--         - Higher values increase contrast in low-intensity regions-->
  <!--         - Recommended range: 10-30-->
  <!--    This parameter is ignored for 'linear', 'hist', and 'off' modes.-->
  <!--    Default: 6 (balanced value for most applications)."-->
  <arg name="ir_enhancement_coefficient" default="6"/>

  <!--  Use internal timer of device -->
  <arg name="use_device_time"                   default="true" />
  
  <!--<arg name="auto_exposure"                   default="true" /> -->
  <!--<arg name="auto_white_balance"              default="true" /> -->

  <!-- Arguments for remapping all device namespaces -->
  <arg name="rgb"              default="rgb" />
  <arg name="ir"               default="ir" />
  <arg name="depth"            default="depth" />

  <!-- Optionally suppress loading the driver nodelet and/or publishing the default tf
       tree. Useful if you are playing back recorded raw data from a bag, or are
       supplying a more accurate tf tree from calibration. -->
  <arg name="load_driver" default="true" />
  <arg name="publish_tf" default="true" />
  <!-- Processing Modules -->
  <arg name="rgb_processing"                  default="true"  />
  <arg name="debayer_processing"              default="false" />
  <arg name="ir_processing"                   default="false" />
  <arg name="depth_processing"                default="true" />
  <arg name="depth_registered_processing"     default="true" />
  <arg name="disparity_processing"            default="false" />
  <arg name="disparity_registered_processing" default="false" />
  
  <!--<arg name="hw_registered_processing"        default="true" if="$(arg depth_registration)" /> -->
  <!--<arg name="sw_registered_processing"        default="false" if="$(arg depth_registration)" /> -->
  <!--<arg name="hw_registered_processing"        default="false" unless="$(arg depth_registration)" /> -->
  <!--<arg name="sw_registered_processing"        default="true" unless="$(arg depth_registration)" /> -->
  <arg name="hw_registered_processing"        default="false" />
  <arg name="sw_registered_processing"        default="false" />

  <!-- Disable bond topics by default -->
  <arg name="respawn" default="false" />

  <!-- Worker threads for the nodelet manager -->
  <arg name="num_worker_threads" default="4" />

  <!-- Push down all topics/nodelets into "camera" namespace -->
  <group ns="$(arg camera)">
  
	  <!-- Start nodelet manager -->
	  <arg name="manager" value="$(arg camera)_nodelet_manager" />
	  <arg name="debug" default="false" /> <!-- Run manager in GDB? -->

    <include if="$(arg use_ros_nodelet)"
        file="$(find percipio_launch)/launch/includes/manager.launch.xml">
	    <arg name="name" value="$(arg manager)" />
	    <arg name="debug" value="$(arg debug)" />
	    <arg name="num_worker_threads"  value="$(arg num_worker_threads)" />
	  </include>

    <!-- Load driver -->
    <include if="$(arg load_driver)"
	     file="$(find percipio_launch)/launch/includes/device.launch.xml">
      <arg name="use_ros_nodelet"                 value="$(arg use_ros_nodelet)" /> 
      <arg name="manager"                         value="$(arg manager)" />
      <arg name="camera"                          value="$(arg camera)" />
      <arg name="device_id"                       value="$(arg device_id)" />
      <arg name="device_reconnection"             value="$(arg device_reconnection)" />
      
      <arg name="rgb_frame_id"                    value="$(arg rgb_frame_id)" />
      <arg name="depth_frame_id"                  value="$(arg depth_frame_id)" />
      <arg name="rgb"                             value="$(arg rgb)" />
      <arg name="ir"                              value="$(arg ir)" />
      <arg name="depth"                           value="$(arg depth)" />
      <arg name="respawn"                         value="$(arg respawn)" />

      <arg name="color_undistortion"              value="$(arg color_undistortion)" />
      <arg name="depth_registration"              value="$(arg depth_registration)" />

      <arg name="ir_undistortion"                 value="$(arg ir_undistortion)" />

      <arg name="depth_speckle_filter"              value="$(arg depth_speckle_filter)" />
      <arg name="max_speckle_size"                  value="$(arg max_speckle_size)" />
      <arg name="max_speckle_diff"                  value="$(arg max_speckle_diff)" />
      <arg name="max_physical_size"                  value="$(arg max_physical_size)" />

      <arg name="depth_time_domain_filter"          value="$(arg depth_time_domain_filter)" />
      <arg name="depth_time_domain_num"             value="$(arg depth_time_domain_num)" />

      <arg name="ir_enhancement"                    value="$(arg ir_enhancement)" />
      <arg name="ir_enhancement_coefficient"        value="$(arg ir_enhancement_coefficient)" />

      <arg name="use_device_time"                   value="$(arg use_device_time)" />

      <arg name="device_log_enable" value="$(arg device_log_enable)" />
      <arg name="device_log_level" value="$(arg device_log_level)" />
      <arg name="device_log_server_port" value="$(arg device_log_server_port)" />

      <arg name="frame_rate_control" value="$(arg frame_rate_control)" />
      <arg name="frame_rate" value="$(arg frame_rate)" />
      <arg name="trigger_mode" value="$(arg trigger_mode)" />
      <arg name="soft_trigger_topic" value="$(arg soft_trigger_topic)" />

      <arg name="dynamic_configure_topic" value="$(arg dynamic_configure_topic)" />

      <!--<arg name="auto_exposure"                   value="$(arg auto_exposure)" /> -->
      <!--<arg name="auto_white_balance"              value="$(arg auto_white_balance)" /> -->
      <arg name="rgb_resolution"                  value="$(arg rgb_resolution)" />
      <arg name="depth_resolution"                value="$(arg depth_resolution)" />

      <arg name="rgb_format"                      value="$(arg rgb_format)" />
      <arg name="depth_format"                    value="$(arg depth_format)" />

    </include>

  </group> <!-- camera -->

</launch>
